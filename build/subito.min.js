function Subito(a,b){this.scores=[],this.canvas=a,this.renderer=new SubitoRenderer(a,b)}function SubitoScore(){this.meta={},this.systems=[]}function SubitoSystem(){this.instrument=null,this.staves=[],this.voices=[]}function SubitoVoice(){this.notes=[],this.stem=null}function SubitoStave(){this.measures=[],this.clef=null,this.time={beat:null,type:null},this.key={fifths:0,mode:"major"},this.lines=5}function SubitoMeasure(){this.elements=[],this.clef=null,this.time={beat:null,type:null},this.key={fifths:0,mode:"major"}}function SubitoClef(a){if(!SubitoClef.Clefs[a])throw new Subito.Exception("Invalid Clef type");this.sign=a,this.line=SubitoClef.Clefs[a].line,this.glyph=SubitoClef.Clefs[a].glyph,this.c4=SubitoClef.Clefs[a].c4}function SubitoNote(a){this.note=a||null,this.voice=null,this.beams=[],this.rest=!1}function SubitoRenderer(a,b){var c=a&&a.tagName?a.tagName.toLowerCase():null;if(c==="canvas")this.context=a.getContext("2d");else{if(c!=="svg")throw new Subito.Exception("Invalid canvas. Must be either <canvas> or <svg> element");this.context=new SubitoSVGContext(a,this)}}Subito.prototype.render=function(){this.renderer.render(this.scores[0])},Subito.prototype.parse=function(a,b){if(!a||!b)return!1;b=Subito.ParserTable[b.toLowerCase()];if(typeof Subito.Parser[b]=="function"){var c=new Subito.Parser[b](a),d;try{d=c.parseScore(),this.scores.push(d)}catch(e){return console.error(e),!1}return!0}return!1},Subito.Parser={},Subito.ParserTable={musicjson:"MusicJSON",musicxml:"MusicXML",lilypond:"LilyPond",subito:"SubitoScript",subitoscript:"SubitoScript"},Subito.Exception=function(a,b){this.code=a||"SubitoException",this.message=String(b)||"Unknown Subito Exception"},Subito.Exception.prototype=Error.prototype,Subito.C4=24,SubitoScore.prototype.metadata=function(a,b){if(!a&&!b)return this.meta;if(a&&!b)return this.meta[a]||null;if(a&&b)return this.meta[a]=b},SubitoScore.prototype.render=function(a){a.settings.renderTitle&&this.meta.title&&(a.context.save(),a.context.fillText(this.meta.title,20,20),a.context.restore());for(var b=0,c=this.systems.length;b<c;b++)this.systems[b].render(a)},SubitoScore.prototype.getMetrics=function(){},SubitoSystem.prototype.render=function(a){for(var b=0,c=this.staves.length;b<c;b++)this.staves[b].render(a);!(this.staves.length>1),!this.instrument||!this.instrument.name},SubitoSystem.prototype.getBoundingBox=function(){},SubitoStave.prototype.render=function(a){var b=this.getBoundingBox(),c,d;for(c=0,d=this.measures.length;c<d;c++)c==0?(a.settings.measure.renderClef=!0,a.settings.measure.renderTime=!0,a.settings.measure.renderKey=!0):c==1&&(a.settings.measure.renderClef=!1,a.settings.measure.renderTime=!1,a.settings.measure.renderKey=!1),this.measures[c].render(a,this)},SubitoStave.prototype.getBoundingBox=function(){if(this.cachedBBox)return this.cachedBBox;var a={length:0},b;for(var c=0,d=this.measures.length;c<d;c++)b=this.measures[c].getBoundingBox(this),a.length+=b.length;return this.cachedBBox=a},SubitoMeasure.prototype.render=function(a,b){a.settings.measure.renderClef&&(this.clef=this.clef||b.clef,this.clef.render(a,this));var c=this.getBoundingBox(b);for(var d=0,e=5;d<e;d++)a.context.beginPath().moveTo(0,a.settings.stave.linespace*d).lineTo(c.right.x,a.settings.stave.linespace*d).stroke();for(d=0,e=this.elements.length;d<e;d++)c=this.elements[d].getBoundingBox(),this.elements[d].render(a,this),a.context.position.x+=c.right.x},SubitoMeasure.prototype.getBoundingBox=function(a){if(this.cachedBBox)return this.cachedBBox;var b={left:{x:0,y:0},right:{x:0,y:0}},c=this.clef||a.clef,d;for(var e=0,f=this.elements.length;e<f;e++)d=this.elements[e].getBoundingBox(),b.right.x+=d.right.x;return b.right.x<100&&(b.right.x=100),this.cachedBBox=b,b},SubitoClef.prototype.render=function(a,b){a.context.renderGlyph(this.glyph,0,a.settings.stave.linespace*this.line)},SubitoClef.Clefs={g:{line:3,glyph:"clefs.G",c4:5},f:{line:1,glyph:"clefs.F",c4:-1},c:{line:2,glyph:"clefs.C",c4:2},g_change:{line:3,glyph:"clefs.G_change",c4:5},f_change:{line:1,glyph:"clefs.F_change",c4:-1},c_change:{line:2,glyph:"clefs.C._change",c4:2}},SubitoNote.prototype.render=function(a,b){var c=this.getHeadGlyph(),d=-1*(this.note.key(!0)-Subito.C4)/2,e=b.clef.c4,f=a.settings.stave.linespace*(e+d),g,h;a.context.renderGlyph(c,0,f);if(e+d>=5){h=Math.floor(e+d-5)+1;for(g=0;g<h;g++)a.context.beginPath().moveTo(35,a.settings.stave.linespace*(5+g)).lineTo(55,a.settings.stave.linespace*(5+g)).stroke()}else if(e+d<=-1){h=-Math.round(e+d)+1;for(g=0;g<h;g++)a.context.beginPath().moveTo(35,0-a.settings.stave.linespace*g).lineTo(55,0-a.settings.stave.linespace*g).stroke()}},SubitoNote.prototype.getBoundingBox=function(a){return{left:{x:0,y:0},right:{x:20,y:50}}},SubitoNote.prototype.getHeadGlyph=function(){var a=null;return this.note.duration>=4?a="noteheads.s2":this.note.duration==2?a="noteheads.s1":this.note.duration==1&&(a="noteheads.s0"),a},SubitoRenderer.prototype.render=function(a){a.render(this)},SubitoRenderer.prototype.extendCanvas=function(a){a.renderGlyph=function(a,b,c){var d=SubitoRender.Fonts[SubitoRender.ActiveFont];if(!d.glyphs[a])return Subito.log("Unsupported Glyph: "+a,"warn");var e=d.glyphs[a].path.split(" "),f={start:{x:b,y:c},coords:{x:0,y:0},controlpoint:{x:null,y:null}};Subito.Settings.debug&&(this.fillStyle="#FF0000",this.beginPath(),this.arc(b,c,2,0,Math.PI*2,!0),this.closePath(),this.fill()),this.fillStyle="#000000",this.beginPath();for(var g=0,h=e.length;g<h;g++)switch(e[g]){case"M":f.coords.x=parseFloat(e[++g]),f.coords.y=parseFloat(e[++g]),this.moveTo(f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"l":f.coords.x+=parseFloat(e[++g]),f.coords.y+=parseFloat(e[++g]),this.lineTo(f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"h":f.coords.x+=parseFloat(e[++g]),this.lineTo(f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"v":f.coords.y+=parseFloat(e[++g]),this.lineTo(f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"q":f.controlpoint.x=f.coords.x+parseFloat(e[++g]),f.controlpoint.y=f.coords.y+parseFloat(e[++g]),f.coords.x+=parseFloat(e[++g]),f.coords.y+=parseFloat(e[++g]),this.quadraticCurveTo(f.start.x+f.controlpoint.x/d.resolution,f.start.y+f.controlpoint.y/d.resolution,f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"t":if(f.controlpoint.x===null||f.controlpoint.y===null)return;f.controlpoint.x=f.coords.x+(f.coords.x-f.controlpoint.x),f.controlpoint.y=f.coords.y+(f.coords.y-f.controlpoint.y),f.coords.x+=parseFloat(e[++g]),f.coords.y+=parseFloat(e[++g]),this.quadraticCurveTo(f.start.x+f.controlpoint.x/d.resolution,f.start.y+f.controlpoint.y/d.resolution,f.start.x+f.coords.x/d.resolution,f.start.y+f.coords.y/d.resolution);break;case"z":this.closePath()}this.strokeStyle="#000000",this.stroke()},a.getWidth=function(){return parseFloat(this.getAttribute("width"))}},SubitoRenderer.prototype.settings={renderTitle:!1,font:"Gonville",margin:20.5,zoom:1,measure:{},stave:{linespace:7}};var SubitoSVGContext=function(){function b(a,b){this.context=a,this.renderer=b,this.pen={x:0,y:0},this.path="",this.position={x:0,y:0},this.state={scale:{x:1,y:1}},this.attributes={stroke:"black",transform:"translate("+this.renderer.settings.margin+", "+this.renderer.settings.margin+")"},this.font={family:"Arial",size:16},this.stateStack=[]}function c(b){return document.createElementNS(a,b)}var a="http://www.w3.org/2000/svg";return b.prototype={moveTo:function(a,b){return this.path+="M"+a+","+b,this.pen.x=a,this.pen.y=b,this},lineTo:function(a,b){return this.path+="L"+a+","+b,this.pen.x=a,this.pen.y=b,this},beginPath:function(){return this.path="",this.pen.x=0,this.pen.y=0,this},closePath:function(){return this.path+="Z",this.pen.x=0,this.pen.y=0,this},stroke:function(){var a=c("path");a.setAttribute("d",this.path);for(var b in this.attributes)a.setAttribute(b,this.attributes[b]);return this.context.appendChild(a),this},fillText:function(a,b,d){var e=c("text");return e.setAttribute("x",b),e.setAttribute("y",d),e.textContent=a,this.context.appendChild(e),this},save:function(){this.stateStack.push({state:Object.create(this.state),font:Object.create(this.font),attributes:Object.create(this.attributes)})},restore:function(){var a=this.stateStack.pop();this.font=a.font,this.attributes=a.attributes,this.state=a.state},renderGlyph:function(a,b,d,e){var f=Subito.Fonts[this.renderer.settings.font];if(!f)throw new Subito.Exception("Invalid Font");var g=f.glyphs[a];if(!g)throw new Subito.Exception("Couldn't found glyph: "+a);e||(b+=this.position.x),this.position.x+=g.hoz*f.scale.x||0;var h=c("path");h.setAttribute("d",g.path),h.setAttribute("transform","translate("+this.renderer.settings.margin+", "+this.renderer.settings.margin+") translate("+b+", "+d+") scale("+f.scale.x+", "+f.scale.y+")"),this.context.appendChild(h)},getSize:function(){return{width:parseFloat(this.context.getAttribute("width")),height:parseFloat(this.context.getAttribute("height"))}}},b}();Subito.Parser.MusicJSON=function(){function a(a){this.source=JSON.parse(a)}function b(a){var b=new SubitoMeasure,c,d,e;if(Object.prototype.toString.call(a.note)==="[object Array]")for(var f=0,g=a.note.length;f<g;f++)d=a.note[f],e=teoria.note(d.pitch.step+d.pitch.octave,d.duration),c=new SubitoNote(e),b.elements.push(c);else d=a.note,e=teoria.note(d.pitch.step+d.pitch.octave,d.duration),c=new SubitoNote(e),b.elements.push(c);return b}return a.prototype={parseScore:function(){if(!this.source)return!1;var a=this.source,c=a["score-partwise"],d=c.part,e=d.measure,f=new SubitoScore,g=new SubitoSystem,h=new SubitoStave;h.clef=new SubitoClef("g");var i;g.staves.push(h),f.systems.push(g);if(Object.prototype.toString.call(e)==="[object Array]")for(var j=0,k=e.length;j<k;j++)h.measures.push(b(e[j]));else h.measures.push(b(e));return f}},a}()